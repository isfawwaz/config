# Copyright from kentcdodds
name: CI
on:
  push:
    branches:
      - '+([0-9])?(.{+([0-9]),x}).x'
      - 'main'
      - 'next'
      - 'next-major'
      - 'dev'
      - 'beta'
      - 'alpha'
      - 'pre/rc'
      - '!all-contributors/**'
  pull_request: {}
jobs:
  main:
    # ignore all-contributors PRs
    if: ${{ !contains(github.head_ref, 'all-contributors') || !contains('docs', github.event.head_commit.message) }}
    strategy:
      matrix:
        node: ['14.15.0', '16.10.0', 18]
    runs-on: ubuntu-latest
    steps:
      - name: üõë Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.10.0

      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: ‚ñ∂Ô∏è Run lint & test
        uses: ./.github/actions/lint_test

      - name: ‚¨ÜÔ∏è Upload coverage report
        uses: codecov/codecov-action@v3

  scanner:
    needs: main
    if: ${{ !contains(github.head_ref, 'all-contributors') || !contains('docs', github.event.head_commit.message) }}
    runs-on: ubuntu-latest
    steps:
      - name: SonarQube Scanner
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          # If you wish to fail your job when the Quality Gate is red, uncomment the
          # following lines. This would typically be used to fail a deployment.
          # - uses: sonarsource/sonarqube-quality-gate-action@master
          #   timeout-minutes: 5
          #   env:
          #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  release:
    needs: main
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'isfawwaz/config' &&
      contains('refs/heads/main,refs/heads/beta,refs/heads/next,refs/heads/alpha,refs/heads/pre/rc', github.ref) &&
      github.event_name == 'push' }}
    strategy:
      matrix:
        node: [16]
    steps:
      - name: üõë Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.10.0

      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: ‚éî Setup node
        uses: ./.github/actions/setup

      - name: üöÄ Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: 'isfawwaz'
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GIT_AUTHOR_EMAIL: 'isfawwaz@gmail.com'
          GIT_COMMITTER_EMAIL: 'mewpip@gmail.com'
          GIT_AUTHOR_NAME: 'isfawwaz'
          GIT_COMMITTER_NAME: 'cepot-gepeng'
        run: pnpm run publish-packages
